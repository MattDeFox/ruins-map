<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ruins Map – Guild Control Prototype</title>
  <style>
    :root {
      --map-bg: #a3aaba;
      --tile-stroke: #3b3b3b;
      --label-color: #0b0f18;
      --ruin1-color: #dfeafe;
      --ruin2-color: #cddcf9;
      --ruin3-color: #e6efff;
      --ruin4-color: #edf4fe;
      --ruin5-color: #bdd0f8;
      --throne-color: #dfeafe;
    }
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 14px;
      padding: 14px;
      background: radial-gradient(60vmax 60vmax at 10% 0%, #101525 0, #0b0d12 55%);
      color: var(--ink, #e6e9f2);
      font: 14px/1.4 system-ui, sans-serif;
    }
    #mapWrap {
      background: var(--map-bg);
      border: 1px solid #243048;
      border-radius: 14px;
      position: relative;
      display: grid;
      place-items: center;
      padding: 10px;
    }
    #mapBox {
      width: min(90vmin, 800px);
      max-width: 800px;
      min-width: 600px;
      aspect-ratio: 1 / 1;
      position: relative;
    }
    @media (max-width: 720px) {
      body { grid-template-columns: 1fr; }
      #mapBox { width: 92vmin; min-width: 0; }
    }
    object#map {
      width: 100%;
      height: 100%;
      display: block;
      background: var(--map-bg);
      border-radius: 10px;
    }
    #svgHost {
      position: absolute;
      inset: 0;
      display: none;
    }
    #ui {
      background: var(--panel, #121620);
      border: 1px solid #243048;
      border-radius: 14px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    h1 {
      font-size: 16px;
      margin: 0 0 8px;
      color: #d9e2ff;
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    input[type="text"], input[type="color"], button {
      border-radius: 8px;
      padding: 8px 10px;
    }
    input[type="text"] {
      background: #0e1321;
      color: var(--ink, #e6e9f2);
      border: 1px solid #27324a;
      width: 90px;
      text-transform: uppercase;
    }
    input[type="color"] {
      width: 40px;
      height: 36px;
      border: none;
      cursor: pointer;
    }
    button {
      background: #182134;
      color: var(--ink, #e6e9f2);
      border: 1px solid #2d3a58;
      cursor: pointer;
    }
    button.primary {
      border-color: #3a56ff55;
      box-shadow: inset 0 0 0 1px #3a56ff33;
    }
    button.danger {
      border-color: #ff6b6b66;
      color: #ffc9c9;
    }
    button:disabled {
      opacity: .45;
      cursor: not-allowed;
    }
    #legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border: 1px solid #33405f;
      border-radius: 20px;
      background: var(--chip, #1b2232);
      cursor: pointer;
    }
    .chip .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #888;
    }
    .chip.active {
      outline: 2px solid var(--accent, #7aa2ff);
    }
    .chip .code {
      font-weight: 700;
      letter-spacing: .5px;
    }
    .chip .rm {
      margin-left: 4px;
      opacity: .7;
      font-size: 12px;
    }
    #io {
      width: 100%;
      min-height: 140px;
      background: #0d1220;
      color: #dbe1f7;
      border: 1px solid #2a3654;
      border-radius: 10px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .hint {
      color: var(--muted, #8a93a6);
      font-size: 12px;
    }
    .sep {
      height: 1px;
      background: #22304a;
      margin: 4px 0;
      opacity: .6;
    }
    .svg-label {
      fill: var(--label-color);
      font-size: 28px;
      font-weight: 900;
      text-anchor: middle;
      dominant-baseline: middle;
      pointer-events: none;
      user-select: none;
      stroke: #666;
      stroke-width: 0.5;
    }
  </style>
</head>
<body>
  <div id="mapWrap">
    <div id="mapBox">
      <object id="map" data="RuinsMapX.svg" type="image/svg+xml"></object>
      <div id="svgHost"></div>
    </div>
  </div>
  <aside id="ui">
    <div>
      <h1>Guilds</h1>
      <div class="row">
        <input id="guildCode" maxlength="3" placeholder="TAG" />
        <input type="color" id="guildColor" value="#7aa2ff" />
        <button id="addGuild" class="primary">Add</button>
        <button id="clearGuilds" class="danger">Clear All</button>
      </div>
      <div id="legend"></div>
      <div class="hint">Tip: click a chip to make it active. Click again to deactivate. Shift+Click a tile to unassign.</div>
    </div>
    <div class="sep"></div>
    <div>
      <h1>Tiles</h1>
      <div class="row">
        <button id="clearAssignments" class="danger">Unassign All Tiles</button>
        <button id="repaint">Repaint</button>
      </div>
    </div>
    <div class="sep"></div>
    <div>
      <h1>Save / Load</h1>
      <div class="row">
        <button id="exportBtn">Export JSON</button>
        <button id="importBtn" class="primary">Import JSON</button>
        <button id="wipeStorage" class="danger">Wipe Storage</button>
      </div>
      <textarea id="io" spellcheck="false" placeholder="Click Export to see state here, or paste JSON then Import."></textarea>
      <div class="hint">State is saved in <code>localStorage</code> as <code>ruinsMapState</code>.</div>
    </div>
  </aside>

  <script>
    (function(){
      const STORAGE_KEY = 'ruinsMapState';
      const MAX_TILES_PER_GUILD = 4;
      const typeColors = {
        '1': 'var(--ruin1-color)',
        '2': 'var(--ruin2-color)',
        '3': 'var(--ruin3-color)',
        '4': 'var(--ruin4-color)',
        '5': 'var(--ruin5-color)',
        'throne': 'var(--throne-color)'
      };
      const fallbackColors = {
        '1': '#dfeafe',
        '2': '#cddcf9',
        '3': '#e6efff',
        '4': '#edf4fe',
        '5': '#bdd0f8',
        'throne': '#dfeafe'
      };

      let svg = null, tilePaths = [], activeGuild = null;
      let guilds = new Map(), assignments = {};

      const tileSelector = 'path[id^="ruin"], path[id*="ruin"], path[id^="throne"], path[id*="throne"]';
      const mapObj = document.getElementById('map');
      const svgHost = document.getElementById('svgHost');
      const codeInput = document.getElementById('guildCode');
      const colorInput = document.getElementById('guildColor');
      const legend = document.getElementById('legend');
      const io = document.getElementById('io');

      function getRuinType(id) {
  const m = id.match(/ruin(\d+)/i);
  if (m) return m[1];
  if (/throne/i.test(id)) return 'throne';  // this catches "throne1"
  return null;
}
      
function addLabels() {
  if (!svg) return;

  svg.querySelector('#_labels')?.remove();
  const labelLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  labelLayer.setAttribute('id', '_labels');
  labelLayer.setAttribute('pointer-events', 'none');

  const paths = Array.from(svg.querySelectorAll(tileSelector));

  for (const p of paths) {
    const id = p.id || p.getAttribute('id');
    const type = getRuinType(id);
    if (!type) continue;

    const bbox = p.getBBox();
    const cx = bbox.x + bbox.width / 2;
    const cy = bbox.y + bbox.height / 2;

    const code = assignments[id];

    if (code) {
      const guildColor = guilds.get(code) || '#888';

      // Top line: Guild tag
      const tagText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      tagText.setAttribute('x', cx);
      tagText.setAttribute('y', cy - 10);
      tagText.setAttribute('class', 'svg-label');
      tagText.setAttribute('fill', guildColor);
      tagText.setAttribute('stroke', '#000');
      tagText.setAttribute('stroke-width', '1');
      tagText.setAttribute('font-size', '24');
      tagText.textContent = code;
      labelLayer.appendChild(tagText);
    }

    // Bottom line: Ruin type or ♛
    const ruinText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ruinText.setAttribute('x', cx);
    ruinText.setAttribute('y', cy + 14);
    ruinText.setAttribute('class', 'svg-label');
    ruinText.setAttribute('fill', '#fff');
    ruinText.setAttribute('stroke', '#000');
    ruinText.setAttribute('stroke-width', '1');
    ruinText.setAttribute('font-size', type === 'throne' ? '38' : '28');
    ruinText.textContent = type === 'throne' ? '♛' : type;
    labelLayer.appendChild(ruinText);
  }

  svg.appendChild(labelLayer);
}
      
      function repaintAll() {
        tilePaths.forEach(p => paintTile(p));
        addLabels();
      }

      function attachInteractivity() {
        tilePaths = Array.from(svg.querySelectorAll(tileSelector));
        tilePaths.forEach(p => {
          p.style.cursor = 'pointer';
          p.addEventListener('click', e => {
            const id = p.id || p.getAttribute('id');
            const cur = assignments[id];
            const type = getRuinType(id);
            if (e.shiftKey || !activeGuild) {
              delete assignments[id];
            } else {
              const isThrone = type === 'throne';
              const count = Object.values(assignments).filter(v => v === activeGuild).length;
              const isAssigning = cur !== activeGuild;
              if (isAssigning && count >= MAX_TILES_PER_GUILD && !isThrone) {
                alert(`Guild ${activeGuild} reached max of ${MAX_TILES_PER_GUILD} tiles.`);
                return;
              }
              assignments[id] = isAssigning ? activeGuild : undefined;
              if (assignments[id] === undefined) delete assignments[id];
            }
            paintTile(p);
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ guilds: Object.fromEntries(guilds), assignments }));
          });
        });
        repaintAll();
      }

      async function loadSVG() {
        try {
          const url = mapObj.getAttribute('data');
          const resp = await fetch(url);
          const text = await resp.text();
          const parsed = new DOMParser().parseFromString(text, 'image/svg+xml');
          const root = parsed.documentElement;
          svgHost.innerHTML = '';
          svgHost.appendChild(document.importNode(root, true));
          svg = svgHost.querySelector('svg');
          svg.setAttribute('width', '100%');
          svg.setAttribute('height', '100%');
          svgHost.style.display = 'block';
          mapObj.style.display = 'none';
          return true;
        } catch (err) {
          alert('Error loading SVG: ' + err.message);
          return false;
        }
      }

      function renderLegend() {
        legend.innerHTML = '';
        for (const [code, color] of guilds) {
          const chip = document.createElement('div');
          chip.className = 'chip' + (activeGuild === code ? ' active' : '');
          chip.innerHTML = `<span class="dot" style="background:${color}"></span><span class="code">${code}</span><span class="rm">✕</span>`;
          chip.querySelector('.rm').addEventListener('click', () => {
            guilds.delete(code);
            Object.keys(assignments).forEach(k => {
              if (assignments[k] === code) delete assignments[k];
            });
            if (activeGuild === code) activeGuild = null;
            renderLegend(); repaintAll();
          });
          chip.addEventListener('click', () => {
            activeGuild = (activeGuild === code) ? null : code;
            renderLegend();
          });
          legend.appendChild(chip);
        }
      }

      document.getElementById('addGuild').onclick = () => {
        const code = (codeInput.value || '').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 3);
        if (!code || guilds.has(code)) return;
        if (guilds.size >= 25) return alert('Max 25 guilds.');
        guilds.set(code, colorInput.value);
        activeGuild = code;
        codeInput.value = '';
        renderLegend();
      };

      document.getElementById('clearGuilds').onclick = () => {
        if (confirm('Clear all guilds?')) {
          guilds.clear(); assignments = {}; activeGuild = null;
          renderLegend(); repaintAll();
        }
      };

      document.getElementById('clearAssignments').onclick = () => {
        if (confirm('Unassign all tiles?')) {
          assignments = {}; repaintAll();
        }
      };

      document.getElementById('repaint').onclick = repaintAll;

      document.getElementById('exportBtn').onclick = () => {
        io.value = JSON.stringify({ guilds: Object.fromEntries(guilds), assignments }, null, 2);
      };

      document.getElementById('importBtn').onclick = () => {
        try {
          const obj = JSON.parse(io.value);
          guilds = new Map(Object.entries(obj.guilds || {}));
          assignments = obj.assignments || {};
          renderLegend(); repaintAll();
        } catch {
          alert('Invalid JSON');
        }
      };

      document.getElementById('wipeStorage').onclick = () => {
        localStorage.removeItem(STORAGE_KEY);
        alert('Storage cleared.');
      };

      mapObj.addEventListener('load', async () => {
        const ok = await loadSVG();
        if (ok) attachInteractivity();
      });

      // Restore state
      try {
        const state = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (state) {
          guilds = new Map(Object.entries(state.guilds || {}));
          assignments = state.assignments || {};
        }
      } catch {}
      renderLegend();
    })();
  </script>
</body>
</html>
